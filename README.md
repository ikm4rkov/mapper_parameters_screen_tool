# **Пайплайн для поиска оптимального сочетания инструмента для картирования и его параметров**

Этот репозиторий содержит скриты для картирования на референсный геном данных в формате FASTQ, сборки контактов и фильтрации контактов по CIGAR-строке,а также  создания отчетов оптимальности наборов параметров в виде TSV-файлов и диграмм рассеивания.

В состав входят:

- Утилиты для конвертации SAM/BAM и сортировки
- Скрипты для построения RNA–DNA контактов (классификация Unique/Other)
- Генератор отчётов со статистикой и scatter-плотами
- Единый рабочий процесс для тестирования и выбора оптимального маппера/набора параметров

Этот репозиторий создавался как **инструмент для поиска наиболее подходящего маппера с оптимальными параметрами** для конкретных FASTQ-данных.

---

# **Структура репозитория**

```
project_root/
│
├── reports/ # Итоговые статистики + scatterplots
│ └── *.tsv / *.png # Сводные таблицы и визуальные отчёты
│
├── indexing.sh # Построение индексов для всех мапперов
│
├── master_mapping.sh # Главный пайплайн картирования
├── master_until_cigar.sh # Пайплайн построения контактов (BAM → контакты)
├── scatterplots.py # Генератор отчётов
│
├── bowtie2_montecarlo.py # Монте-Карло генератор параметров + запуск Bowtie2
├── star_montecarlo.py # Монте-Карло генератор параметров + запуск STAR
│
├── bwa_mapping.sh # BWA с экспертными параметрами
├── hisat2_mapping.sh # Hisat2 с фиксированными параметрами
│
├── sam2bam_and_sort.sh # SAM → BAM + сортировка по read-ID
│
├── make_contacts_universal_notsample.sh # Универсальный конструктор контактов (all/random)
├── make_contacts_sample.sh # Конструктор контактов из предоставленного списка TSV
├── rename.py # Скрипт для сокращения имени файла (в gpfs разрешены имена до 255 символов, для ветки collab этого может быть недостаточно)
│
└── README.md
```

---

# **Описание скриптов**

## **1. indexing.sh**
Строит индексы для всех четырёх мапперов.

**Использование:**

./indexing.sh <genome_fasta> <gtf_file> <output_prefix> <threads>


Результат: директории индексов STAR, Bowtie2, Hisat2 и BWA.

---

## **2. master_mapping.sh**
### **Назначение**
Управляющий процессом картирования скрипт. Он:

1. Принимает FASTQ-данные в заданной директории  
2. Запускает картирование выбранным картировщиком  
3. Размещает SAM/BAM-файлы в соответствующие поддиректории  

### **Поддерживаемые режимы**
- STAR, Bowtie2, Hisat2, BWA  
- Фиксированные явно прописанные в worker-скриптах наборы параметров из тех, что влияют на результат картирования.
- Монте-Карло режим скриннинга для STAR и Bowtie2  

### ! Для картировщиков BWA и Hisat2 требуется иметь имя файла формата ID.<dna|rna>.extension!

Пока что не поддерживает batch-вычисления, обработка ведется по одному файлу. 

### **Пример**

./master_mapping.sh
--fastq-dir fastq_data/id.fastq
--part rna
--seed 42
--genome-dir indexes/star/
--mapper star
--threads 8


---

## **3. master_until_cigar.sh**
### **Назначение**
Управляющий сборкой контактов и фильтрацией по CIGAR-строке скрипт.

Выполняет:

1. Сортировку всех SAM/BAM (`sam2bam_and_sort.sh`)
2. Построение контактов:
   - `make_contacts_universal_notsample.sh` (режим all/random)
   - или `make_contacts_sample.sh`
3. Перемещение сырых контактов (`*.tab.rc`)
4. Фильтрацию контактов по CIGAR (`calculate_CIAGAR_filter.sh`)
5. Упорядочивание выходной структуры

### **Пример**

./master_until_cigar.sh
--base-dir mapping_out/
--raw-contacts raw_contacts/
--mode all
--mapper-branch collab
--mapper BWA

### ! Значение опции --mapper-branch зависит от выбранного для картирования инструмента: BWA и Hisat2 - ветка "collab", Bowtie 2 и STAR - ветка "native". Опция влияет на логику обработки каталога файлов!

### ! Пока что указание опции --mapper автоматически не устанавливает значение опции --mapper-branch. Значение "BWA" будет означать, что мультимапперы в файле картирования обозначаются через тэг в одной записи в стиле вывода BWA, значение "STAR" и "Hisat2" аналогичны, взаимозаменяемы и соместимы с Bowtie 2, все они записывают мультимапперы в несколько записей с одинаковым идентификатором чтения!
---

## **4. scatterplots.py**
### **Назначение**
Скрипт создания отчетов.

Функциональность:

- Автоматическая классификация Unique_RNA и Other
- Подсчёт pairtypes (UU, UM, MU, UN и др.)
- Вычисление:
  - необработанные и отфильтрованные UU/UM
  - уникально картированные RNA (U_m_R)
  - уникально картированные DNA (U_m_D)
- Сохранение:
  - TSV-таблицы
  - PNG-графиков:
    - `_UU_UM.png`
    - `_UniqueRNA_DNA.png`

### **Пример**

python3 scatterplots.py
-r raw_contacts/
-i filtered_contacts/
-d reports/
-o mydataset


---

## **5. bowtie2_montecarlo.py**
Выполняет **случайную выборку параметров Bowtie2** из набора предопределённых диапазонов и выполняет картирование для каждого набора.

---

## **6. star_montecarlo.py**
Аналогичен Bowtie2-версии, но для **STAR**, с генерацией набора параметров и запуском картирования для каждого из них.

---

## **7. bwa_mapping.sh**
Запускает BWA с **экспертно подобранными параметрами**.  
Параметры фиксированы, без случайности.

---

## **8. hisat2_mapping.sh**
Запускает Hisat2 с набором проверенных параметров.

---

## **9. sam2bam_and_sort.sh**
Конвертирует SAM → BAM и сортирует риды по **ID**  
(требование для корректной сборки контактных пар).

---

## **10. make_contacts_universal_notsample.sh**
Генерирует контакты при структуре директорий:

<base-dir>/
rna/
dna/


Поддерживает:
- **all-mode**
- **random-mode** (`--count`, `--seed`, `--different`)

Результат: `*.tab.rc` (сырые контакты).

---

## **11. make_contacts_sample.sh**
То же, что универсальный инструмент, но использует **заданный пользователем TSV-список** пар.

---

## **12. rename.py**
Скрипт, сокращающий названия файлов сырых контактов. Превращает наименования параметров картирования в численные индексы и создает JSON файл с сопоставлением индексов и замененных строк в директории использования.

---

# **Установка**

### **1 - клонирование репозитория**

git clone https://github.com/ikm4rkov/mapper_parameters_screen_tool.git
cd mapper_parameters_screen_tool

### **2 - установка зависимостей Python**

pip install -r requirements.txt

### **3 - установка GNU Parallel (приведена сборка из исходников)**

wget https://ftp.gnu.org/gnu/parallel/parallel-latest.tar.bz2
tar -xf parallel-latest.tar.bz2
cd parallel-<версия>
./configure
make
make install

### **4 - зависимости от репозиториев коллег**

Данный репозиторий опирается на отдельные вспомогательные скрипты:

* 1. EditDistance_CIGAR_filter.py из https://github.com/ryabykh2018/nf-rnachrom-EditDistance_CIGAR_filter
* 2. Bam_to_Contacts_prerelease2.py из https://github.com/ilnitsky/nf-rnachrom/tree/26f9d2d9325726233adada02e2d36a981ff270b8/bin

Необходимо добавить их в переменную PATH, либо указать до них путь в скриптах для картирования (...montecarlo.py, <картировщик>...mapping.sh).

### **5 - наличие картировщиков**

Предполагается, что код из репозитория будет тестировать 4 картировщика: Bowtie 2, BWA-mem, Hisat2 и STAR. Для начала работы они должны быть установлены.

### **6 - входные данные**

Принимаются данные в формате FASTQ. Для тестирования использовались преобработанные (после удаления ПЦР-адаптеров, ПЦР-дублей и линкерной последовательности) данные протокола GRID-seq из исследования домашней свиньи (https://doi.org/10.1186/s12915-022-01322-2). Выборка получена, с помощью seqkit sample. **! Для проверки картироващиков BWA и Hisat2 необходимо иметь название файлов как <ID>.<dna|rna>.fastq, так как по символу точке и последующей строке производится обработка ДНК- или РНК-части контактов.** Пока что не реализована batch-обработка набора файлов: для обработки каждого входного файла требуется провести отедельный запуск.

---


# **Основной рабочий процесс**

### **1 — построить индексы**

./indexing.sh genome.fa annotation.gtf myindex 16


### **2 — выполнить картирование**

./master_mapping.sh --fastq-dir fastq/id.fastq --mapper star --part rna --seed 42 --genome-dir myindex_STAR/ --threads 8 


### **3 — построить контакты**

./master_until_cigar.sh --base-dir map_out/ --raw-contacts raw/ --mode all --mapper BWA


### **4 — сформировать отчёт**

python3 scatterplots.py -r raw/ -i filtered_contacts/ -d reports/ -o sample1


---

# **Выходные данные**

Финальные результаты находятся в:


reports/
│ sample1.tsv
│ sample1_UU_UM.png
│ sample1_UniqueRNA_DNA.png


Эти данные позволяют сравнить эффективность мапперов и выбрать оптимальный набор параметров по качеству уникального картирования и контактных данных.

---
